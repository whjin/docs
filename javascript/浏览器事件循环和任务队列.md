`JS`的异步机制由事件循环和任务队列构成。

`JS`异步依赖于浏览器或操作系统等完成。`JS`主线程拥有一个执行栈以及一个任务队列，主线程会依次执行代码，当遇到函数时，会先将函数入栈，函数运行完毕后再将函数出栈，直到所有代码执行完毕。

遇到异步操作时，异步操作会由浏览器执行，浏览器会在这些任务完成后，将事件定义的回调函数推入主线程的任务队列中，当主线程的执行栈清空之后会读取任务队列中的回调函数，当任务队列被读取完毕之后，主线程接着执行，从而进入一个无限的循环，这就是事件循环。

**1、 浏览器中的`Event Loop`**

事件循环中的异步队列有两种：宏任务队列和微任务队列。宏任务队列可以有多个，微任务队列只有一个。

`JS`有一个主线程和调用栈（执行栈），所有的任务都会被放到调用栈等待主线程执行。

**`JS`调用栈**

`JS`调用栈采用的是后进先出的规则，当函数执行时，会被添加到栈的顶部，当执行栈执行完成后，就会从栈顶移除，知道栈内被清空。

**同步任务和异步任务**

`JS`单线程任务被分为同步任务和异步任务，同步任务会在调用栈中按照顺序等待主线程依次执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列等待主线程空闲时（调用栈被清空），被读取到栈内等待主线程的执行。

- 常见的宏任务：`setTimeout`、`setInterval`、`setImmediate`、`script`代码块、`I/O`操作、`UI`渲染等
- 常见微任务：`process.nextTick`、`new Promise().then(cb)`、`MutationObserver`等

当宏任务执行完后，会查看是否有微任务队列。如果有，先执行微任务队列中的所有任务，如果没有，会读取宏任务队列中排在最前的任务，执行宏任务的过程中，遇到微任务，依次加入微任务队列。
栈空后，再次读取微任务队列里的任务，以此类推。

**2、`Node.js`中的事件循环**

`Node.js`中的`Event Loop`和浏览器中的是完全不相同的。`Node.js`采用`V8`作为`JS`的解析引擎，而`I/O`处理方面使用了自己设计的`libuv`，`libuv`是一个事件驱动的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的`API`，事件循环机制也是它里面的实现。

`Node`中的`Event Loop`是基于`libuv`实现的，而`libuv`是`Node`的新跨平台抽象层，`libuv`使用异步事件驱动的编程方式，核心是提供`I/O`的事件循环和异步回调。`libuv`的`API`包含有事件非阻塞的网络，异步文件操作，子进程等。`Event Loop`就是在`libuv`中实现的。

**事件循环的进程模型**

1. 选择当前要执行的任务队列，选择任务队列中最先进入的任务，如果任务队列为空即`null`，则执行跳转到微任务的执行步骤
2. 将事件循环中的任务设置为已选择任务
3. 执行任务
4. 将事件循环中当前运行任务设置为`null`
5. 将已经运行完成的任务从任务队列中删除
6. 微任务步骤：进入微任务检查点
7. 更新界面渲染
8. 返回第一步

**执行进入微任务检查点时，用户代理会执行以下步骤：**

1. 设置微任务检查点标记为`true`
2. 当事件循环微任务执行不为空时：选择一个最先进入的微任务队列的微任务，将事件循环的微任务设置为已选择的微任务，运行微任务，将已经执行完成的微任务置为`null`，移除微任务队列中的微任务。
3. 清理`IndexDB`事务
4. 设置进入微任务检查点的标记为`false`

执行栈在执行完同步任务后，查看执行栈是否为空，如果执行栈为空，就会去检查微任务队列是否为空，如果为空，就执行宏任务，否则就一次性执行完所有微任务。

每次单个宏任务执行完毕后，检查微任务队列是否为空，如果不为空，会按照先进先出的规则全部执行完微任务后，设置为任务队列为`null`，然后再执行宏任务，如此循环。

**堆（`Heap`）**

堆是一种数据结构，是利用完全二叉树维护的一组数据，堆分为两种，一种为最大堆，一种为最小堆，将根节点最大的堆叫做最大堆或跟堆，根节点最小的堆叫做最小堆或小根堆。

堆是线性数据结构，相当于一维数组，有唯一后继。

**栈（`Stack`）**

栈在计算机科学中是限定仅在表尾进行插入或删除操作的线性表。栈是一种数据结构，它按照后进先出的原则存储数据，先进入的数据被压入栈底，最后的数据在栈顶，需要读数据的时候从栈顶开始弹出数据。

栈是只能在某一端插入或删除的特殊线性表。

**队列（`Queue`）**

特殊之处在于它允许在表的前端进行删除操作，而在表的后端进行插入操作，和栈一样，队列是一种操作受限制的线性表。

进行插入操作的短称为队尾，进行删除操作的端称为队头。队列中没有元素时，称为空队列。

队列的数据元素又称为队列元素。在队列中插入一个队列称为入队，从队列中删除一个队列元素称为出队。因为队列只允许在一端插入，在另一端删除，所以只有最早进入队列的元素才能最先从队列中删除，因此队列又称为先进先出。


